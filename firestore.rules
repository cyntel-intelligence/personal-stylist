rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function isValidString(value, minLen, maxLen) {
      return value is string && value.size() >= minLen && value.size() <= maxLen;
    }

    function isValidEmail(email) {
      return email is string && email.matches('.*@.*\\..*');
    }

    // User profiles - users can only read/write their own profile
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    // Legacy user_profiles collection (keep for backwards compatibility)
    match /user_profiles/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    // Events - users can only access their own events
    // Note: requirements object supports: mustUseClosetItems, preferRewear, shopOnlyMode
    match /events/{eventId} {
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && isValidString(request.resource.data.eventType, 1, 50)
                    && request.resource.data.dateTime is timestamp;
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
    }

    // Closet items - users can only access their own closet
    match /closet_items/{itemId} {
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && isValidString(request.resource.data.category, 1, 50)
                    && request.resource.data.images is map
                    && request.resource.data.images.original is string;
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
    }

    // Recommendations - users can only access recommendations for their events
    match /recommendations/{recommendationId} {
      allow read: if isAuthenticated()
                  && (resource.data.userId == request.auth.uid
                      || get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.userId == request.auth.uid);
      allow create: if isAuthenticated()
                    && (request.resource.data.userId == request.auth.uid
                        || get(/databases/$(database)/documents/events/$(request.resource.data.eventId)).data.userId == request.auth.uid);
      allow update: if isAuthenticated()
                    && (resource.data.userId == request.auth.uid
                        || get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.userId == request.auth.uid);
      allow delete: if isAuthenticated()
                    && (resource.data.userId == request.auth.uid
                        || get(/databases/$(database)/documents/events/$(resource.data.eventId)).data.userId == request.auth.uid);
    }

    // Feedback - users can only access their own feedback
    match /feedback/{feedbackId} {
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid
                    && request.resource.data.rating is number
                    && request.resource.data.rating >= 1
                    && request.resource.data.rating <= 5;
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
    }

    // API usage tracking - only server can write, users can read their own
    match /api_usage/{usageId} {
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;
      allow write: if false; // Only server-side writes via Admin SDK
    }

    // Rate limiting - only server can write
    match /rate_limits/{userId} {
      allow read: if isOwner(userId);
      allow write: if false; // Only server-side writes via Admin SDK
    }

    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
